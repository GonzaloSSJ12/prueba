<!DOCTYPE html>
<html>
<head>
    <title>Detección de Señas con IA</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <style>
        #video-container { position: relative; }
        #video { transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; }
        .controls { margin: 20px 0; }
        input, button { margin: 5px; padding: 8px; }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" id="gestureName" placeholder="Nombre de la seña">
        <button onclick="startTraining()">Agregar Seña</button>
        <button onclick="startDetection()">Comenzar Detección</button>
    </div>
    <div id="video-container">
        <video id="video" width="640" height="480" autoplay></video>
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>
    <div id="status">Estado: Sin entrenar</div>
    <div id="result"></div>

<script>
let detector;
let video;
let canvas;
let ctx;
let classifier = knnClassifier.create();
let trainingData = {};
let currentGesture = null;
let trainingSamples = 0;
let isTraining = false;
let isDetecting = false;

async function setupCamera() {
    video = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    
    return new Promise((resolve) => {
        video.onloadedmetadata = () => {
            resolve(video);
        };
    });
}

async function initializeHandDetection() {
    detector = await handPoseDetection.createDetector(
        handPoseDetection.SupportedModels.MediaPipeHands,
        {
            runtime: 'mediapipe',
            modelType: 'full',
            solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/'
        }
    );
}

function drawHands(hands) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hands.forEach(hand => {
        hand.keypoints.forEach(point => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = 'red';
            ctx.fill();
        });
    });
}

async function getHandEmbedding(hand) {
    const keypoints = hand.keypoints.map(point => [point.x, point.y, point.z]);
    return tf.tensor2d(keypoints.flat(), [1, 63]);
}

async function processFrame() {
    if (!isTraining && !isDetecting) return;
    
    const hands = await detector.estimateHands(video);
    drawHands(hands);
    
    if (hands.length > 0) {
        const embedding = await getHandEmbedding(hands[0]);
        
        if (isTraining) {
            classifier.addExample(embedding, currentGesture);
            trainingSamples++;
            document.getElementById('status').innerText = 
                `Entrenando: ${currentGesture} (${trainingSamples}/3)`;
            
            if (trainingSamples >= 3) {
                isTraining = false;
                trainingSamples = 0;
                document.getElementById('status').innerText = 
                    `Seña ${currentGesture} entrenada!`;
            }
        }
        
        if (isDetecting) {
            const result = await classifier.predictClass(embedding);
            document.getElementById('result').innerText = 
                `Seña detectada: ${result.label}`;
        }
    }
    
    requestAnimationFrame(processFrame);
}

async function startTraining() {
    currentGesture = document.getElementById('gestureName').value;
    if (!currentGesture) return alert('Ingresa un nombre de seña');
    
    isTraining = true;
    trainingSamples = 0;
    document.getElementById('gestureName').value = '';
}

async function startDetection() {
    isDetecting = true;
    document.getElementById('status').innerText = 'Modo detección activo';
}

async function init() {
    await setupCamera();
    video.play();
    
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');
    
    await initializeHandDetection();
    setInterval(processFrame, 100);
}

init();
</script>
</body>
</html>v
